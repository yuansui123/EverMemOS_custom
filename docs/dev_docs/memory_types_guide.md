# EverMemOS Memory Types: Episode / Foresight / EventLog

---

## 1. Architecture Overview

```
┌────────────────────────────────────────────────────────────────────────────────┐
│                          Conversation Event Stream                             │
│                                    ↓                                           │
│                           ┌───────────────┐                                    │
│                           │   MemCell     │  ← boundary-detected chunk         │
│                           │  (memory unit)│                                    │
│                           └───────┬───────┘                                    │
│                                   │                                            │
│   ┌───────────────┬───────────────┼───────────────┬───────────────┐            │
│   │               │               │               │               │            │
│   ↓               ↓               ↓               ↓               ↓            │
│ ┌────────────────┐ ┌────────────────┐  ┌─────────────┐ ┌─────────────┐         │
│ │ Group Episode  │ │Personal Episode│  │  Foresight  │ │  EventLog   │         │
│ │ (all scenes)   │ │ (group chat)   │  │ (assistant  │ │ (assistant  │         │
│ └────────────────┘ └────────────────┘  │  scene only)│ │  scene only)│         │
│                                        └─────────────┘ └─────────────┘         │
└────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Memory Type Details

### 2.1 MemCell

**Definition**: The smallest memory container generated by boundary detection from continuous conversations.

**Core Fields**:

| Field | Description |
|-------|-------------|
| `event_id` | Unique identifier |
| `original_data` | Raw message list |
| `timestamp` | MemCell timestamp |
| `summary` | Topic summary |
| `participants` | Participant list |
| `group_id` | Group identifier |

**Business Purpose**:
- Source of all downstream memories
- Guarantees each unit represents a full topic
- **One-to-many relationship**: Each MemCell can produce multiple downstream memories (Episode, Foresight, EventLog), but each downstream memory **comes from exactly one MemCell**

---

### 2.2 Episode Memory

**Definition**: Narrative summary extracted from a MemCell, providing a higher-level semantic understanding.

**Types**:

| Type | `user_id` | Description |
|------|-----------|-------------|
| Group Episode | `None` | Third-person, group-wide narration |
| Personal Episode | concrete user ID | First-person view for a participant |

**Core Fields**:

| Field | Description |
|-------|-------------|
| `subject` | Title |
| `summary` | Short summary |
| `episode` | Full narrative |
| `memcell_event_id_list` | Source MemCell IDs |

**Business Purpose**:
- Human-readable understanding for assistants
- Supports downstream reasoning tasks

---

### 2.3 Foresight

> ⚠️ **Note**: Foresight is only extracted in **assistant scene** (1:1 chat), not in group chat.

**Definition**: Predictive memories describing how the conversation may impact future decisions. Extracted directly from MemCell.

**Core Fields**:

| Field | Description |
|-------|-------------|
| `foresight` | Prediction text |
| `evidence` | Supporting clue |
| `start_time` / `end_time` | Valid timeframe |
| `duration_days` | Validity length |
| `parent_type` | Parent memory type (Memcell/Episode) |
| `parent_id` | Parent memory ID (for linking) |

**Business Purpose**:
- Power proactive reminders and planning
- Support forecasting or “what will happen” questions
- Time-aware filtering based on validity

**Example**:
```json
{
  "foresight": "User may need to deliver the project report before next Wednesday.",
  "evidence": "Conversation mentioned 'deadline next Wednesday'.",
  "start_time": "2024-03-10",
  "end_time": "2024-03-17",
  "duration_days": 7
}
```

---

### 2.4 EventLog

> ⚠️ **Note**: EventLog is only extracted in **assistant scene** (1:1 chat), not in group chat.

**Definition**: Atomic facts extracted directly from MemCell/conversation; every fact is an independent retrieval unit.

> ⚠️ **Important**: The LLM returns a list of `atomic_fact`, but each fact is persisted as its own `EventLogRecord`.

**MongoDB schema (`event_log_records`)**:

| Field | Description |
|-------|-------------|
| `atomic_fact` | Single fact string |
| `vector` | Embedding for the fact |
| `parent_type` | Parent memory type (Memcell/Episode) |
| `parent_id` | Parent memory ID (for linking) |
| `timestamp` | Occurrence time |
| `user_id` / `group_id` | Ownership info |

**Business Purpose**:
- Fine-grained hybrid/vector retrieval
- Answer factual “who did what when” questions
- Reduce noise compared with long passages

**Example (3 records)**:
```json
{ "atomic_fact": "Alice proposed a new product design.", "parent_type": "memcell", "parent_id": "mc_001" }
{ "atomic_fact": "Bob confirmed the feasibility.", "parent_type": "memcell", "parent_id": "mc_001" }
{ "atomic_fact": "Team starts prototyping next Monday.", "parent_type": "memcell", "parent_id": "mc_001" }
```

---

## 3. Quantity Ratios

### 3.1 Baseline

| Layer | DB Records | Notes |
|-------|-----------|-------|
| MemCell | 1 | One per boundary |
| Episode | 1 (assistant) / 1+N (group) | assistant: 1 group (copied to user); group: 1 group + N personal |
| Foresight | ~10 | **Assistant scene only**, 4-10 items per MemCell |
| EventLog | **M** | **Assistant scene only**, M = atomic facts (5–15 typical) |

### 3.2 Scenario Examples

**Scenario A: Assistant Chat (1:1)**
```
MemCell: 1
├── Group Episode: 1 (copied to user)
├── Foresight: ~10 (extracted from MemCell)
├── EventLog: ~8 (extracted from MemCell)
└── Total records: 1 Episode + 10 Foresight + 8 EventLog = 19
```

**Scenario B: Group Chat (3 participants)**
```
MemCell: 1
├── Group Episode: 1
├── Personal Episode (User A): 1
├── Personal Episode (User B): 1
├── Personal Episode (User C): 1
├── Foresight: 0 (NOT extracted in group chat)
├── EventLog: 0 (NOT extracted in group chat)
└── Total records: 4 Episodes
```

> **Note**: Foresight and EventLog are only extracted in assistant (1:1) scenes for efficiency.

---

## 4. Retrieval Guidance

| Query Need | Best Memory Type | Retrieval Method |
|------------|------------------|------------------|
| Narrative context | Episode | vector + BM25 |
| Precise fact lookup | EventLog | vector on atomic facts |
| Future reminders | Foresight | time filter + vector |
| Persona/profile info | Profile | direct lookup (not covered here) |

---

## 5. Storage & Indexes

### 5.1 Persistence

| Memory | Collection | Description |
|--------|------------|-------------|
| MemCell | `memcells` | raw storage |
| Episode | `episodic_memories` | narrative docs |
| Foresight | `foresight_records` | predictions |
| EventLog | `event_log_records` | atomic facts |

### 5.2 Search Indexes

| Memory | Elasticsearch | Milvus |
|--------|---------------|--------|
| Episode | ✅ | ✅ |
| Foresight | ✅ | ✅ |
| EventLog | ✅ | ✅ (per fact) |

---

## 6. Code Entry Points

### 6.1 Extraction Flow

```python
# Main pipeline
biz_layer/mem_memorize.py::memorize()
    └── process_memory_extraction()
        ├── _extract_episodes()      # All scenes
        ├── _extract_foresights()    # Assistant scene only
        └── _extract_event_logs()    # Assistant scene only
```

### 6.2 Extractors

```
memory_layer/memory_extractor/
├── episode_memory_extractor.py
├── foresight_extractor.py
└── event_log_extractor.py
```

### 6.3 Retrieval Interfaces

```python
agentic_layer/memory_manager.py::MemoryManager
    ├── retrieve_mem()
    ├── retrieve_lightweight()   # embedding/BM25/RRF
    └── retrieve_agentic()       # multi-round LLM-guided
```

---

## 7. FAQs

**Q1: Why split Group vs Personal Episode?**  
- Group records collective facts; personal captures user-centric perspective; retrieval can filter by `user_id`.

**Q2: Is "10 foresights" hard-coded?**  
- The extractor targets 4-10 items, but fewer items are accepted if the LLM provides less content.
- **Only extracted in assistant scene** (not in group chat).

**Q3: How many EventLog records per MemCell?**  
- Depends on LLM output; every atomic fact becomes one document (typically 5–15).
- **Only extracted in assistant scene** (not in group chat).

**Q4: Which memory type should I query?**  
- Narrative/story: Episode  
- Concrete fact: EventLog  
- Future impact/reminder: Foresight

---

## 8. Version History

| Version | Date | Notes |
|---------|------|-------|
| v1.0 | 2024-12 | Initial release |
| v1.1 | 2025-01 | Foresight/EventLog now extracted from MemCell (assistant scene only) |


